#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require 'masking'
require 'masking/cli'

require 'ruby-prof'

original_stdout = $stdout.clone
$stdout.reopen(File.new(File::NULL, 'w'))

result = RubyProf.profile do
  Masking::Cli.new(ARGV).run
end

$stdout.reopen(original_stdout)

flat_result_file = Pathname(__dir__).join('../profile/flat.txt')
RubyProf::FlatPrinter.new(result).tap do |flat_printer|
  # flat_printer.print(STDOUT)
  flat_printer.print(File.new(flat_result_file, 'w'))
  puts "result is saved at #{flat_result_file}"
end

## it will produce huge html file. just comment out if you want to use it
# graph_html_file = Pathname(__dir__).join('../profile/graph.html')
# RubyProf::GraphHtmlPrinter.new(result).tap do |graph_html_printer|
#   graph_html_printer.print(File.new(graph_html_file, 'w'))
#   puts "graph html is saved at #{graph_html_file}"
# end
